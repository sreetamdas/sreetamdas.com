import { readFile, writeFile } from "node:fs/promises";

function getArgValue(flag) {
	const idx = process.argv.indexOf(flag);
	if (idx === -1) return undefined;
	const value = process.argv[idx + 1];
	if (!value || value.startsWith("--")) return undefined;
	return value;
}

function sqlString(value) {
	if (value == null) return "NULL";
	const str = String(value);
	// SQLite string literal escaping
	return `'${str.replace(/'/g, "''")}'`;
}

function sqlNumber(value, fallback = 0) {
	const n = typeof value === "number" ? value : Number(value);
	if (!Number.isFinite(n)) return String(fallback);
	return String(Math.trunc(n));
}

const inPath = getArgValue("--in") ?? "./supabase-page_details.json";
const outPath = getArgValue("--out") ?? "./d1-import-page_details.sql";

/**
 * Generates an idempotent SQL import for D1 from a Supabase JSON export.
 *
 * Usage:
 *   node scripts/d1-generate-import-sql.mjs --in ./page_details.json --out ./import.sql
 *
 * Then run:
 *   pnpm wrangler d1 execute sreetamdas_com --remote --file ./import.sql
 */

const raw = await readFile(inPath, "utf8");
const rows = JSON.parse(raw);

if (!Array.isArray(rows)) {
	throw new Error(`Expected JSON array in ${inPath}`);
}

let sql = "-- Generated by scripts/d1-generate-import-sql.mjs\n";
sql += "BEGIN TRANSACTION;\n";

for (const row of rows) {
	const slug = row.slug;
	if (typeof slug !== "string" || slug.length === 0) {
		throw new Error(`Invalid slug in input: ${JSON.stringify(row)}`);
	}

	const viewCount = sqlNumber(row.view_count, 0);
	const likes = sqlNumber(row.likes, 0);
	const createdAt = sqlString(row.created_at);
	const updatedAt = sqlString(row.updated_at);

	sql +=
		"INSERT INTO page_details (slug, view_count, likes, created_at, updated_at) VALUES (" +
		sqlString(slug) +
		`, ${viewCount}, ${likes}, ${createdAt}, ${updatedAt}) ` +
		"ON CONFLICT(slug) DO UPDATE SET " +
		"view_count=excluded.view_count, " +
		"likes=excluded.likes, " +
		"created_at=excluded.created_at, " +
		"updated_at=excluded.updated_at;\n";
}

sql += "COMMIT;\n";

await writeFile(outPath, sql, "utf8");
console.log(`Wrote ${rows.length} rows to ${outPath}`);
